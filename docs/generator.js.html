<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>generator.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-auto-size-input-AutoSizeInput.html">AutoSizeInput</a><ul class='methods'><li data-type='method'><a href="module-auto-size-input-AutoSizeInput.html#_getWidth">_getWidth</a></li><li data-type='method'><a href="module-auto-size-input-AutoSizeInput.html#render">render</a></li></ul></li><li><a href="module-calendar-Calendar.html">Calendar</a><ul class='methods'><li data-type='method'><a href="module-calendar-Calendar.html#render">render</a></li></ul></li><li><a href="module-calendar-CalendarDay.html">CalendarDay</a><ul class='methods'><li data-type='method'><a href="module-calendar-CalendarDay.html#_makeClassName">_makeClassName</a></li><li data-type='method'><a href="module-calendar-CalendarDay.html#render">render</a></li></ul></li><li><a href="module-calendar-CalendarItem.html">CalendarItem</a><ul class='methods'><li data-type='method'><a href="module-calendar-CalendarItem.html#_getPartClassName">_getPartClassName</a></li><li data-type='method'><a href="module-calendar-CalendarItem.html#_onClick">_onClick</a></li><li data-type='method'><a href="module-calendar-CalendarItem.html#render">render</a></li></ul></li><li><a href="module-calendar-CalendarItemEditor.html">CalendarItemEditor</a><ul class='methods'><li data-type='method'><a href="module-calendar-CalendarItemEditor.html#_changed">_changed</a></li><li data-type='method'><a href="module-calendar-CalendarItemEditor.html#render">render</a></li></ul></li><li><a href="module-calendar-CalendarSlot.html">CalendarSlot</a><ul class='methods'><li data-type='method'><a href="module-calendar-CalendarSlot.html#_addItem">_addItem</a></li><li data-type='method'><a href="module-calendar-CalendarSlot.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="module-calendar-CalendarSlot.html#render">render</a></li></ul></li><li><a href="module-checkbox-Checkbox.html">Checkbox</a><ul class='methods'><li data-type='method'><a href="module-checkbox-Checkbox.html#render">render</a></li></ul></li><li><a href="module-popover-Popover.html">Popover</a><ul class='methods'><li data-type='method'><a href="module-popover-Popover.html#.hidePopover">hidePopover</a></li><li data-type='method'><a href="module-popover-Popover.html#.showPopover">showPopover</a></li><li data-type='method'><a href="module-popover-Popover.html#_generatePath">_generatePath</a></li><li data-type='method'><a href="module-popover-Popover.html#_onClickedOutside">_onClickedOutside</a></li><li data-type='method'><a href="module-popover-Popover.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="module-popover-Popover.html#componentDidUpdate">componentDidUpdate</a></li><li data-type='method'><a href="module-popover-Popover.html#render">render</a></li></ul></li><li><a href="module-schedule-ItemPart.html">ItemPart</a></li><li><a href="module-schedule-Lesson.html">Lesson</a><ul class='methods'><li data-type='method'><a href="module-schedule-Lesson.html#setEndTime">setEndTime</a></li><li data-type='method'><a href="module-schedule-Lesson.html#setStartTime">setStartTime</a></li></ul></li><li><a href="module-schedule-Schedule.html">Schedule</a><ul class='methods'><li data-type='method'><a href="module-schedule-Schedule.html#createItem">createItem</a></li><li data-type='method'><a href="module-schedule-Schedule.html#getEarlistTimeForLesson">getEarlistTimeForLesson</a></li><li data-type='method'><a href="module-schedule-Schedule.html#getItem">getItem</a></li><li data-type='method'><a href="module-schedule-Schedule.html#getLatestTimeForLesson">getLatestTimeForLesson</a></li><li data-type='method'><a href="module-schedule-Schedule.html#remove">remove</a></li></ul></li><li><a href="module-schedule-ScheduleItem.html">ScheduleItem</a><ul class='methods'><li data-type='method'><a href="module-schedule-ScheduleItem.html#setPartsCount">setPartsCount</a></li></ul></li><li><a href="module-select-Select.html">Select</a><ul class='methods'><li data-type='method'><a href="module-select-Select.html#render">render</a></li></ul></li><li><a href="module-timetable-CalendarIndexes.html">CalendarIndexes</a><ul class='methods'><li data-type='method'><a href="module-timetable-CalendarIndexes.html#render">render</a></li></ul></li><li><a href="module-timetable-CalendarLessonTime.html">CalendarLessonTime</a><ul class='methods'><li data-type='method'><a href="module-timetable-CalendarLessonTime.html#_formatTime">_formatTime</a></li><li data-type='method'><a href="module-timetable-CalendarLessonTime.html#_getInputClassName">_getInputClassName</a></li><li data-type='method'><a href="module-timetable-CalendarLessonTime.html#_parseTime">_parseTime</a></li><li data-type='method'><a href="module-timetable-CalendarLessonTime.html#_timeBlur">_timeBlur</a></li><li data-type='method'><a href="module-timetable-CalendarLessonTime.html#_timeChanged">_timeChanged</a></li><li data-type='method'><a href="module-timetable-CalendarLessonTime.html#render">render</a></li></ul></li><li><a href="module-toolbar-ToolBar.html">ToolBar</a><ul class='methods'><li data-type='method'><a href="module-toolbar-ToolBar.html#_onGenerateButtonPressed">_onGenerateButtonPressed</a></li><li data-type='method'><a href="module-toolbar-ToolBar.html#render">render</a></li></ul></li><li><a href="module-weekdays-WeekDay.html">WeekDay</a></li></ul><h3>Modules</h3><ul><li><a href="module-auto-size-input.html">auto-size-input</a></li><li><a href="module-calendar.html">calendar</a></li><li><a href="module-checkbox.html">checkbox</a></li><li><a href="module-generator.html">generator</a><ul class='methods'><li data-type='method'><a href="module-generator.html#~canGenerate">canGenerate</a></li><li data-type='method'><a href="module-generator.html#~generate">generate</a></li></ul></li><li><a href="module-popover.html">popover</a></li><li><a href="module-schedule.html">schedule</a></li><li><a href="module-select.html">select</a></li><li><a href="module-timetable.html">timetable</a></li><li><a href="module-toolbar.html">toolbar</a></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#~range">range</a></li></ul></li><li><a href="module-weekdays.html">weekdays</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">generator.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Модуль содержит функции для генерации файлов .ics
 * @module generator
 */

let ical = require("ical-generator");
let moment = require("moment");

/**
 * Проверяет, известно ли время начала и конца каждого занятия, для которых
 * определены события в календаре.
 *
 * @param  {Schedule} - Объект расписания
 * @return {boolean} Возможно ли создание файла
 */
function canGenerate(schedule){
    for (let i = 0; i &lt; schedule.items.length; i++){
        if (!schedule.items[i].lesson.startTimeDefined || !schedule.items[i].lesson.endTimeDefined){
            return false;
        }
    }
    return true;
}


/**
 * Генерирует файл .ics по заданному расписанию и предоставляет его на скачивание
 * пользователю.
 *
 * @param  {Schedule} schedule - Объект расписания
 * @param  {string} startDate - Дата начала семестра в формате &lt;code>ГГГГ-ММ-ДД&lt;/code>
 * @param  {string} endDate - Дата конца семестра в формате &lt;code>ГГГГ-ММ-ДД&lt;/code>
 */
function generate(schedule, startDate, endDate){
    // TODO: Change domain
	let calendar = ical({domain: "localhost", name: "Schedule"});
    let day = moment(startDate).startOf("day");
    let weekIndex = 0;
    for (let dayIndex = 0; dayIndex &lt; 7; dayIndex++){
        let weekDay = day.isoWeekday() - 1;
        for (let lessonIndex = 0; lessonIndex &lt; schedule.lessonsCount; lessonIndex++){
            let item = schedule.getItem(weekDay, lessonIndex);
            if (typeof item != "undefined"){
                let lessonStart = day.clone().add(schedule.lessons[lessonIndex].startTime, "minutes");
                let lessonEnd = day.clone().add(schedule.lessons[lessonIndex].endTime, "minutes");
                for (let partIndex = 0; partIndex &lt; item.partsCount; partIndex++){
                    let index = (partIndex + weekIndex) % item.partsCount;
                    if (item.parts[index].active){
                        calendar.createEvent({
                            start: lessonStart.clone().add(partIndex, "weeks").toDate(),
                            end: lessonEnd.clone().add(partIndex, "weeks").toDate(),
                            summary: item.parts[index].name,
                            repeating: {
                                freq: "WEEKLY",
                                interval: item.partsCount,
                                until: moment(endDate).toDate()
                            },
                            location: item.parts[partIndex].locaiton
                        });
                    }
                }
            }
        }
        day.add(1, "days");
        if (day.isoWeekday() == 1){
            weekIndex = 1;
        }
    }

    let string = calendar.toString();
    let element = document.createElement("a");
    element.setAttribute("download", "schedule.ics")
    element.setAttribute("href", "data:text/calendar;charset=utf-8," + encodeURIComponent(string));
    element.style.display = "none";

    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

module.exports = {
    generate: generate,
    canGenerate: canGenerate
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Apr 23 2017 00:29:17 GMT+0300 (MSK) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
